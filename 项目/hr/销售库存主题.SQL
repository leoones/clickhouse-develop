----------------------------------------------  dw_hr.fct_sale_shop_sku_day  ----------------------------------------------
alter table dw_hr.fct_sale_shop_sku_day
  delete where stat_day >=toDate('${G_DAY}') and stat_day < addDays(toDate('${G_DAY}'), 1);

insert into dw_hr.fct_sale_shop_sku_day(
	stat_year,
	stat_month ,
	stat_day ,
  buid,
	shopid ,
	placeid ,
	brandid ,
	familyid ,
	categorytreeid,
    categoryid,
	goodsid ,
	shelfid ,
	venderid ,
	payflag ,
	paytypeid ,
	costtaxrate ,
	saletaxrate ,
	logistics ,
	disctype ,
	pickflag ,
	saleqty ,
	salevalue ,
	discvalue ,
	saletax ,
	salecostvalue ,
	costdisc ,
	costtax ,
	discticketvalue
		)
select
  toYear(hsday) as stat_year,
	toYYYYMM(hsday) as stat_month ,
	hsday ,
  multiIf(sssd.source='U50', 18, sssd.source='HBU50', 12, sssd.source='XBU50', 13,
			    sssd.source='DBU50', 15, sssd.source='HDU50', 16, 88) as buid,
	shopid ,
	placeid ,
	toUInt32(brandid) ,
	toUInt64(familyid) ,
  dictGet('dw_buinfo', 'categorytreeid', toUInt64(buid)) as categorytreeid,
  dictGet('dw_good_info', 'categoryid', (buid, goodsid)) as categoryid,
	goodsid ,
	shelfid ,
	venderid ,
	toUInt8(payflag) ,
	toUInt16(paytypeid) ,
	costtaxrate ,
	saletaxrate ,
	toUInt8(logistics) ,
	disctype ,
	toUInt8(pickflag) ,
	saleqty ,
	salevalue ,
	discvalue ,
	saletax ,
	salecostvalue ,
	costdisc ,
	costtax ,
	discticketvalue
from ods_hr.sale_shop_sku_day sssd
where hsday >= toDate('${G_DAY}')
  and hsday  < addDays(toDate('${G_DAY}'), 1);



----------------------------------------------  dw_hr.fct_sale_shop_sku_mon ----------------------------------------------
alter table  dw_hr.fct_sale_shop_sku_mon drop partition  ${G_MONTH};
insert into dw_hr.fct_sale_shop_sku_mon (stat_year,
                                         stat_month,
                                         buid,
                                         shopid,
                                         placeid,
                                         brandid,
                                         familyid,
                                         categorytreeid,
                                         goodsid,
                                         shelfid,
                                         venderid,
                                         payflag,
                                         paytypeid,
                                         logistics,
                                         saleqty,
                                         salevalue,
                                         discvalue,
                                         salecostvalue)
select stat_year,
       stat_month,
       buid,
       shopid,
       placeid,
       brandid,
       familyid,
       categorytreeid,
       goodsid,
       shelfid,
       venderid,
       payflag,
       paytypeid,
       logistics,
       sum(saleqty),
       sum(salevalue),
       sum(discvalue),
       sum(salecostvalue)
  from dw_hr.fct_sale_shop_sku_day fsssd
where fsssd.stat_month = ${G_MONTH}
GROUP BY stat_year,
       stat_month,
       buid,
       shopid,
       placeid,
       brandid,
       familyid,
       categorytreeid,
       goodsid,
       shelfid,
       venderid,
       payflag,
       paytypeid,
       logistics;
